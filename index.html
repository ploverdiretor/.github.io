<!DOCTYPE html>
<html>
<body>
<h1>Oscillator Custom waveform</h1>
<hr/>
<div>
<button id="play">Play</button> <button id="stop">Stop</button><br/>
<table>
<!--<tr><th>Freq</th><td><input type="range" id="freq" min="50" max="1000" value="440"/></td><td id="freqval"></td></tr>-->
<tr><th>key</th><td><input type="range" id="key" min="0" max="87" step="1" value="48"/></td><td id="freqval"></td></tr>
<tr><th>Gain</th><td><input type="range" id="gain" min="0" max="1" step="0.01" value="0.1"/></td><td id="gainval"></td></tr>

<tr><td><br/></td></tr>
<tr><th>Harmonics</th><th>imag</th></tr>
<tr><th>1</th><td><input type="range" min="0" max="1" step="0.01" id="imag1" value="1"/></td><td id="imag1val"></td></tr>
<tr><th>2</th><td><input type="range" min="0" max="1" step="0.01" id="imag2" value="0.5"/></td><td id="imag2val"></td></tr>
<tr><th>3</th><td><input type="range" min="0" max="1" step="0.01" id="imag3" value="0"/></td><td id="imag3val"></td></tr>
<tr><th>4</th><td><input type="range" min="0" max="1" step="0.01" id="imag4" value="0"/></td><td id="imag4val"></td></tr>
<tr><th>5</th><td><input type="range" min="0" max="1" step="0.01" id="imag5" value="0"/></td><td id="imag5val"></td></tr>
<tr><th>6</th><th><input type="range" min="0" max="1" step="0.01" id="imag6" value="0"/></td><td id="imag6val"></td></tr>
<tr><th>7</th><td><input type="range" min="0" max="1" step="0.01" id="imag7" value="0"/></td><td id="imag7val"></td></tr>

<tr><td><br/></td></tr>
<tr><th>Chorus</th><th></th></tr>
<tr><th>Speed</th><td><input type="range" id="speed" min="0.1" max="10" step="0.1" value="7"/></td><td id="speedval"></td></tr>
<tr><th>Depth</th><td><input type="range" id="depth" min="0.000" max="0.005" step="0.0001" value="0.0003"/></td><td id="depthval"></td></tr>
<tr><th>Mix</th><td><input type="range" id="mix" min="0" max="1" step="0.01" value="0.4"/></td><td id="mixval"></td></tr>
<tr><th>Output</th><td><input type="range" id="output" min="0" max="1" step="0.01" value="0.8"/></td><td id="outputval"></td></tr>

<tr><td><br/></td></tr>
<tr><th>Reverb</th><th></th></tr>
<tr><th>Mix</th><td><input type="range" id="revlevel" min="0" max="1" step="0.01" value="0.5"/></td><td id="revlevelval"></td></tr>

</table>

</div>
<script>
window.addEventListener("load", async ()=>{
    const keyTable = [27.5, 29.13523509488062, 30.867706328507758,
    32.70319566257483, 34.64782887210901, 36.70809598967595, 38.890872965260115, 41.20344461410874,
    43.653528929125486, 46.2493028389543, 48.99942949771866, 51.91308719749314, 55.0, 58.27047018976124, 61.735412657015516,
    65.40639132514966, 69.29565774421802, 73.4161919793519, 77.78174593052023, 82.40688922821748,
    87.30705785825097, 92.4986056779086, 97.99885899543732, 103.82617439498628, 110.0, 116.54094037952248, 123.47082531403103,
    130.8127826502993, 138.59131548843604, 146.8323839587038, 155.56349186104046, 164.81377845643496,
    174.61411571650194, 184.9972113558172, 195.99771799087463, 207.65234878997256, 220.0, 233.08188075904496, 246.94165062806206,
    261.6255653005986, 277.1826309768721, 293.6647679174076, 311.1269837220809, 329.6275569128699,
    349.2282314330039, 369.9944227116344, 391.99543598174927, 415.3046975799451, 440.0, 466.1637615180899, 493.8833012561241,
    523.2511306011972, 554.3652619537442, 587.3295358348151, 622.2539674441618, 659.2551138257398,
    698.4564628660078, 739.9888454232688, 783.9908719634985, 830.6093951598903, 880.0, 932.3275230361799, 987.7666025122483,
    1046.5022612023945, 1108.7305239074883, 1174.6590716696303, 1244.5079348883237, 1318.5102276514797,
    1396.9129257320155, 1479.9776908465376, 1567.981743926997, 1661.2187903197805, 1760.0, 1864.6550460723597, 1975.5332050244965,
    2093.004522404789, 2217.4610478149766, 2349.3181433392606, 2489.0158697766474, 2637.0204553029594,
    2793.825851464031, 2959.955381693075, 3135.963487853994, 3322.437580639561, 3520.0, 3729.3100921447194, 3951.066410048993,
    4186.009044809578];
    /*--------------------------オシレーター-------------------------*/
    const audioctx = new AudioContext();
    const osc = new OscillatorNode(audioctx);

    const tablen = 8;
    const real = new Float32Array(tablen);
    const imag = new Float32Array(tablen);

    /*---------------------------コーラス----------------------------*/
    const lfo = new OscillatorNode(audioctx);
    const depth = new GainNode(audioctx);
    const delay = new DelayNode(audioctx, {delayTIme:0.02});
    const mix = new GainNode(audioctx);
    const output = new GainNode(audioctx);
    lfo.frequency.value = document.getElementById("speed").value;
    depth.gain.value = document.getElementById("depth").value;
    mix.gain.value = document.getElementById("mix").value;
    output.gain.value = document.getElementById("output").value;
    lfo.start();
    /*---------------------------リバーブ----------------------------*/
    const irbuf = await LoadSample(audioctx, "ir/s1_r1_bd.wav");
    const convolver = new ConvolverNode(audioctx, {buffer: irbuf});
    const revmix = new GainNode(audioctx);
    const drymix = new GainNode(audioctx);

    /*-----------------------------音量------------------------------*/
    const gain = new GainNode(audioctx);

    /*-----------------------------接続------------------------------*/
    osc.connect(delay).connect(mix).connect(output).connect(convolver).connect(gain).connect(audioctx.destination);
    osc.connect(output)
    output.connect(drymix).connect(gain)
    lfo.connect(depth).connect(delay.delayTime);
    audioctx.suspend();
    osc.start();

    document.getElementById("stop").addEventListener("click", ()=>{
        audioctx.suspend();
    });
    document.getElementById("play").addEventListener("click", ()=>{
        SetupWave();
        audioctx.resume();
    });
    document.getElementById("key").addEventListener("input", Setup);
    document.getElementById("gain").addEventListener("input", Setup);
    for(let i=1;i<8;++i){
      document.getElementById("imag"+i).addEventListener("input", SetupWave);
    }

    document.getElementById("speed").addEventListener("input", Setup);
    document.getElementById("depth").addEventListener("input", Setup);
    document.getElementById("mix").addEventListener("input", Setup);
    document.getElementById("output").addEventListener("input", Setup);
    document.getElementById("revlevel").addEventListener("input", Setup);
    Setup();
    SetupWave();
    function Setup(){
        osc.frequency.value = keyTable[document.getElementById("key").value];
        document.getElementById("freqval").innerHTML= Math.round(keyTable[document.getElementById("key").value]*1000)/1000
        gain.gain.value = document.getElementById("gainval").innerHTML
            = document.getElementById("gain").value;
        const rev = document.getElementById("revlevel").value;
        revmix.gain.value = document.getElementById("revlevelval").innerHTML = rev;
        drymix.gain.value = 1 - rev;
        lfo.frequency.value = document.getElementById("speedval").innerHTML
            = document.getElementById("speed").value;
        depth.gain.value = document.getElementById("depthval").innerHTML
            = document.getElementById("depth").value;
        const mixval = document.getElementById("mixval").innerHTML
            = document.getElementById("mix").value;
        mix.gain.value = mixval;
        output.gain.value = document.getElementById("outputval").innerHTML
            = document.getElementById("output").value;
    }
    function SetupWave(){
        for(i = 0; i < tablen; i++) { // make Harmonics
            real[i] = 0;
            if(i!==0){
              imag[i] = parseFloat(document.getElementById("imag"+i+"val").innerHTML
                  = document.getElementById("imag"+i).value);
            }else{
              imag[i] = 0;
            }
        }
        const waveTable = audioctx.createPeriodicWave(real, imag);	//create periodicWave
        osc.setPeriodicWave(waveTable);	//set to Oscillator
    }
    function LoadSample(actx, url) {
        return new Promise((resolv)=>{
            fetch(url).then((response)=>{
                return response.arrayBuffer();
            }).then((arraybuf)=>{
                return actx.decodeAudioData(arraybuf);
            }).then((buf)=>{
                resolv(buf);
            })
        });
    }
});
</script>
</body>
</html>